'use client';

import { useMemo, useState } from 'react';

import { Card } from '@/components/ui/Card';
import { MissionTracker, StatCard } from '@/components/gamification';
import type { UserSettingWithTimezone } from '@/lib/db/queries/user-settings';
import type { ExecutionRecord, Routine, UserProfile, Mission, UserMission } from '@/types/routine';
import {
  getMonthStartInUserTimezone,
  getWeekStartInUserTimezone,
  isSameDayInUserTimezone,
} from '@/utils/timezone';


import CatchupSuggestions from './CatchupSuggestions';
import ProgressRoutineItem from './ProgressRoutineItem';
import TodayRoutineItem from './TodayRoutineItem';

interface Props {
  routines: Routine[];
  executionRecords: ExecutionRecord[];
  userSettings: UserSettingWithTimezone;
  userProfile?: UserProfile;
}

export default function Dashboard({ routines, executionRecords, userSettings, userProfile }: Props) {
  const [localExecutionRecords, setLocalExecutionRecords] = useState(executionRecords);

  const addExecutionRecord = async (record: Omit<ExecutionRecord, 'id'>) => {
    try {
      const response = await fetch('/api/execution-records', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(record),
      });

      if (!response.ok) {
        throw new Error('å®Ÿè¡Œè¨˜éŒ²ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const result = await response.json();
      if (result.success) {
        setLocalExecutionRecords((prev) => [...prev, result.data]);
      }
    } catch {
      // å®Ÿè¡Œè¨˜éŒ²ã®ä½œæˆã«å¤±æ•—
    }
  };

  // ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«åˆ†å‰²
  const { scheduleBasedRoutines, frequencyBasedRoutines } = useMemo(() => {
    const active = routines.filter((routine) => routine.isActive);

    return {
      scheduleBasedRoutines: active.filter((routine) => routine.goalType === 'schedule_based'),
      frequencyBasedRoutines: active.filter((routine) => routine.goalType === 'frequency_based'),
    };
  }, [routines]);
  
  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ã•ã‚‰ã«åˆ†é¡
  const { dailyScheduleRoutines, weeklyScheduleRoutines, monthlyScheduleRoutines } = useMemo(() => {
    return {
      dailyScheduleRoutines: scheduleBasedRoutines.filter((routine) => routine.recurrenceType === 'daily'),
      weeklyScheduleRoutines: scheduleBasedRoutines.filter((routine) => routine.recurrenceType === 'weekly'),
      monthlyScheduleRoutines: scheduleBasedRoutines.filter((routine) => routine.recurrenceType === 'monthly'),
    };
  }, [scheduleBasedRoutines]);

  // ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒãƒ³ã‚’å–å¾—ï¼ˆãƒ‡ã‚¤ãƒªãƒ¼ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã¿ï¼‰
  const todayRoutines = dailyScheduleRoutines;

  // ä»Šæ—¥å®Œäº†ã—ãŸãƒ«ãƒ¼ãƒãƒ³ã®IDä¸€è¦§
  const todayCompletedRoutineIds = useMemo(() => {
    const timezone = userSettings?.timezone;
    const today = new Date();

    return localExecutionRecords
      .filter((record) => {
        return record.isCompleted && isSameDayInUserTimezone(record.executedAt, today, timezone);
      })
      .map((record) => record.routineId);
  }, [localExecutionRecords, userSettings?.timezone]);

  // é »åº¦ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ï¼ˆé€±é–“ãƒ»æœˆé–“ã®å›æ•°ç›®æ¨™ï¼‰
  const frequencyBasedRoutinesWithProgress = useMemo(() => {
    const timezone = userSettings?.timezone;
    const now = new Date();
    
    return frequencyBasedRoutines.map((routine) => {
      // æœŸé–“ã®é–‹å§‹æ—¥ã‚’å–å¾—
      let periodStart: Date;
      if (routine.targetPeriod === 'weekly') {
        periodStart = getWeekStartInUserTimezone(now, timezone);
      } else if (routine.targetPeriod === 'monthly') {
        periodStart = getMonthStartInUserTimezone(now, timezone);
      } else {
        // daily ã®å ´åˆã¯ä»Šæ—¥ã‹ã‚‰
        periodStart = new Date(now);
        periodStart.setHours(0, 0, 0, 0);
      }
      
      const executedCount = localExecutionRecords.filter(
        (record) =>
          record.routineId === routine.id &&
          record.isCompleted &&
          new Date(record.executedAt) >= periodStart
      ).length;

      const targetCount = routine.targetCount || 1;
      const progress = Math.min(executedCount / targetCount, 1);

      return {
        ...routine,
        executedCount,
        targetCount,
        progress: progress * 100, // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸
        isCompleted: executedCount >= targetCount,
        periodType: routine.targetPeriod || 'daily',
      };
    });
  }, [frequencyBasedRoutines, localExecutionRecords, userSettings?.timezone]);


  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold text-gray-900 dark:text-white">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

      {/* æŒ½å›ãƒ—ãƒ©ãƒ³ææ¡ˆ */}
      <CatchupSuggestions
        routines={routines}
        executionRecords={localExecutionRecords}
        userSettings={userSettings}
      />

      {/* ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆãƒ‡ã‚¤ãƒªãƒ¼ï¼‰ */}
      <Card>
        <h2 className="text-lg font-medium mb-4 text-gray-900 dark:text-white">
          ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³
        </h2>

        {todayRoutines.length === 0 ? (
          <p className="text-gray-500 dark:text-gray-400 text-center py-8">
            ä»Šæ—¥å®Ÿè¡Œã™ã‚‹ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã›ã‚“
          </p>
        ) : (
          <div className="space-y-3">
            {todayRoutines.map((routine) => (
              <TodayRoutineItem
                key={routine.id}
                routine={routine}
                isCompleted={todayCompletedRoutineIds.includes(routine.id)}
                onComplete={addExecutionRecord}
              />
            ))}
          </div>
        )}
      </Card>

      {/* é »åº¦ãƒ™ãƒ¼ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆé€±ã«â—‹å›ã€æœˆã«â—‹å›ï¼‰ */}
      {frequencyBasedRoutinesWithProgress.length > 0 && (
        <Card>
          <h2 className="text-lg font-medium mb-4 text-gray-900 dark:text-white">
            é »åº¦ãƒ™ãƒ¼ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³
          </h2>
          <div className="space-y-3">
            {frequencyBasedRoutinesWithProgress.map((routine) => (
              <ProgressRoutineItem
                key={routine.id}
                routine={routine}
                frequencyType={routine.periodType as 'weekly' | 'monthly'}
                onComplete={addExecutionRecord}
              />
            ))}
          </div>
        </Card>
      )}
      
      {/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³ï¼ˆé€±é–“ãƒ»æœˆé–“ï¼‰ */}
      {(weeklyScheduleRoutines.length > 0 || monthlyScheduleRoutines.length > 0) && (
        <Card>
          <h2 className="text-lg font-medium mb-4 text-gray-900 dark:text-white">
            ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ãƒŸãƒƒã‚·ãƒ§ãƒ³
          </h2>
          <div className="space-y-3">
            {/* é€±é–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */}
            {weeklyScheduleRoutines.map((routine) => (
              <TodayRoutineItem
                key={routine.id}
                routine={routine}
                isCompleted={todayCompletedRoutineIds.includes(routine.id)}
                onComplete={addExecutionRecord}
              />
            ))}
            {/* æœˆé–“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */}
            {monthlyScheduleRoutines.map((routine) => (
              <TodayRoutineItem
                key={routine.id}
                routine={routine}
                isCompleted={todayCompletedRoutineIds.includes(routine.id)}
                onComplete={addExecutionRecord}
              />
            ))}
          </div>
        </Card>
      )}

      {/* ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ */}
      <Card>
        <h2 className="text-lg font-medium mb-4 text-gray-900 dark:text-white flex items-center gap-2">
          ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³
        </h2>
        <MissionTracker
          missions={mockDailyMissions}
          userMissions={mockUserMissions}
          maxDisplay={3}
          variant="list"
          onClaimReward={(missionId) => console.warn('Claim reward:', missionId)}
        />
      </Card>

      {/* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */}
      <div className="grid md:grid-cols-3 gap-4">
        <StatCard
          title="ä»Šæ—¥ã®å®Œäº†"
          value={todayCompletedRoutineIds.length}
          subtitle={`/ ${todayRoutines.length} ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³`}
          icon={<span className="text-lg">âœ…</span>}
          variant="success"
          trend={{
            value: 15,
            isPositive: true,
            period: 'æ˜¨æ—¥æ¯”'
          }}
        />
        <StatCard
          title="é€±é–“é€²æ—"
          value={0}
          subtitle="å®Œäº†ç‡"
          icon={<span className="text-lg">ğŸ“Š</span>}
          variant="primary"
        />
        <StatCard
          title="æœˆé–“é€²æ—"
          value={0}
          subtitle="å®Œäº†ç‡"
          icon={<span className="text-lg">ğŸ—“ï¸</span>}
          variant="warning"
        />
      </div>
    </div>
  );
}

// ãƒ¢ãƒƒã‚¯ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿
const mockDailyMissions: Mission[] = [
  {
    id: 'daily-1',
    title: '3ã¤ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³å®Œäº†',
    description: 'ä»Šæ—¥ä¸­ã«3ã¤ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’å®Œäº†ã—ã‚ˆã†',
    type: 'count',
    targetValue: 3,
    xpReward: 50,
    difficulty: 'easy',
    isActive: true,
    progress: 0,
    createdAt: new Date(),
    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
  },
  {
    id: 'daily-2',
    title: 'æœã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³',
    description: '9:00ã¾ã§ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’1ã¤å®Œäº†ã—ã‚ˆã†',
    type: 'count',
    targetValue: 1,
    xpReward: 30,
    difficulty: 'easy',
    isActive: true,
    progress: 0,
    createdAt: new Date(),
    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
  }
];

const mockUserMissions: UserMission[] = [
  {
    id: 'user-daily-1',
    userId: 'user1',
    missionId: 'daily-1',
    progress: 1,
    isCompleted: false,
    startedAt: new Date()
  },
  {
    id: 'user-daily-2',
    userId: 'user1',
    missionId: 'daily-2',
    progress: 0,
    isCompleted: false,
    startedAt: new Date()
  }
];
